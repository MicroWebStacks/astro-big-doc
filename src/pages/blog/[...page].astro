---
import Layout from "@/layout/Layout.astro";
import {existsSync,readdirSync} from 'fs';
import {resolve} from 'path';
import Panzoom from "@/components/panzoom.astro"
import Gallery from "@/components/gallery.astro"
import {session_user} from "../../../server/auth/auth_utils"

const {page} = Astro.params;
console.log(`Astro> page ${page}`)

const user = session_user(Astro.request) //also adds .user to Astro.request
console.log(`Astro> [...page] ${user?"hello user "+user:""}`)

const page_path = resolve(process.cwd()+'/data/blog/'+page)
if(!existsSync(page_path)){
    console.log(`${page} does not exist`)
    return Astro.redirect("/")
}
//Astro.glob()only use literals, no variables, no string litterals, relative to this file
const posts = await Astro.glob('../../../data/blog/**/*.{md,mdx}')
const Post = posts.find((post)=>(resolve(post.file) == page_path))

if((typeof Post == "undefined")){
    console.log(`${page} could not be imported`)
    return Astro.redirect("/")
}

//TODO if user authorised to view the page, otherwise redirect

//Dummy to allow static build for test but not supported
export async function getStaticPaths(){
    const files = readdirSync('data/blog/')//relative to astro root
    return files.filter(file=>file.endsWith('.mdx')).map((file)=>({params:{page:file}}))
}

---
{Post &&
<Layout title={Post.frontmatter.title} headings={Post.getHeadings()}>
        <Post.Content components={{...Post.components, Gallery,Panzoom,data:Panzoom }}/>
</Layout>
}
